<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages | TalentExchange</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        .chat-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            height: calc(100vh - 8rem);
            gap: 1rem;
        }

        .conversations-list {
            border-right: 1px solid #E5E7EB;
            overflow-y: auto;
        }

        .dark .conversations-list {
            border-right-color: #4B5563;
        }

        .conversation-item {
            padding: 1rem;
            cursor: pointer;
            border-bottom: 1px solid #E5E7EB;
            transition: background 0.2s;
        }

        .dark .conversation-item {
            border-bottom-color: #4B5563;
        }

        .conversation-item:hover {
            background: rgba(78, 205, 196, 0.1);
        }

        .conversation-item.active {
            background: rgba(78, 205, 196, 0.2);
            border-left: 3px solid var(--secondary-teal);
        }

        .messages-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .messages-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
        }

        .message.sent {
            align-self: flex-end;
            background: var(--secondary-teal);
            color: white;
            border-bottom-right-radius: 0.25rem;
        }

        .message.received {
            align-self: flex-start;
            background: #F3F4F6;
            border-bottom-left-radius: 0.25rem;
        }

        .dark .message.received {
            background: #374151;
        }

        .message-input-container {
            padding: 1rem;
            border-top: 1px solid #E5E7EB;
        }

        .dark .message-input-container {
            border-top-color: #4B5563;
        }
    </style>
</head>

<body>
    <div id="sidebarContainer"></div>

    <div class="main-content">
        <div class="container-fluid">
            <h1 class="text-4xl font-bold mb-lg">Messages</h1>

            <div class="card p-0">
                <div class="chat-container">
                    <!-- Conversations List -->
                    <div class="conversations-list">
                        <div class="p-md border-b border-gray-200 dark:border-gray-700">
                            <input type="text" class="input" placeholder="Search conversations..."
                                id="searchConversations">
                        </div>
                        <div id="conversationsList">
                            <!-- Conversations will be loaded here -->
                        </div>
                    </div>

                    <!-- Messages Area -->
                    <div class="messages-container">
                        <div id="chatHeader" class="p-md border-b border-gray-200 dark:border-gray-700">
                            <p class="text-gray-500 dark:text-gray-400">Select a conversation</p>
                        </div>

                        <div id="messagesList" class="messages-list">
                            <!-- Messages will be loaded here -->
                        </div>

                        <div id="messageInputContainer" class="message-input-container hidden">
                            <form id="messageForm" class="flex gap-md">
                                    <input type="text" id="messageInput" class="input flex-1"
                                    placeholder="Write a message..." required>
                                <button type="submit" class="btn btn-primary">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                    </svg>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/data.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/navigation.js"></script>

    <script>
        requireAuth();
        const currentUser = getCurrentUser();
        document.getElementById('sidebarContainer').innerHTML = generateSidebar();
        setActiveNavItem();

        let activeConversation = null;
        const userConversations = getUserConversations(currentUser.id);

        // Check if opening chat with specific user
        const params = getURLParams();
        if (params.user) {
            const targetUserId = parseInt(params.user);
            const targetUser = USERS.find(u => u.id === targetUserId);

            if (targetUser) {
                // Check if conversation exists
                let conversation = userConversations.find(c => c.participants.includes(targetUserId));

                if (!conversation) {
                    // Create new conversation
                    conversation = {
                        id: CHAT_CONVERSATIONS.length + 1,
                        participants: [currentUser.id, targetUserId],
                        participantNames: [currentUser.name, targetUser.name],
                        lastMessage: '',
                        lastMessageDate: new Date().toISOString(),
                        unread: 0,
                        messages: []
                    };
                    CHAT_CONVERSATIONS.push(conversation);
                    userConversations.push(conversation);
                }

                activeConversation = conversation;
            }
        }

        function displayConversations() {
            const container = document.getElementById('conversationsList');
            container.innerHTML = '';

                if (userConversations.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 py-8 text-sm">You have no conversations</p>';
                return;
            }

            userConversations.forEach(conv => {
                const otherUserId = conv.participants.find(id => id !== currentUser.id);
                const otherUser = USERS.find(u => u.id === otherUserId);
                const otherUserName = conv.participantNames.find(name => name !== currentUser.name);

                const item = document.createElement('div');
                item.className = `conversation-item ${activeConversation?.id === conv.id ? 'active' : ''}`;
                item.onclick = () => openConversation(conv);
                item.innerHTML = `
                    <div class="flex items-center gap-md">
                        <img src="${otherUser?.avatar || 'https://i.pravatar.cc/150'}" alt="${otherUserName}" class="avatar">
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start mb-xs">
                                <p class="font-semibold truncate">${otherUserName}</p>
                                <span class="text-xs text-gray-500 dark:text-gray-400">${formatRelativeDate(conv.lastMessageDate)}</span>
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400 truncate">${conv.lastMessage || 'New conversation'}</p>
                        </div>
                        ${conv.unread > 0 ? `<span class="badge badge-primary">${conv.unread}</span>` : ''}
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function openConversation(conv) {
            activeConversation = conv;
            conv.unread = 0;

            const otherUserId = conv.participants.find(id => id !== currentUser.id);
            const otherUser = USERS.find(u => u.id === otherUserId);
            const otherUserName = conv.participantNames.find(name => name !== currentUser.name);

            // Update header
            document.getElementById('chatHeader').innerHTML = `
                <div class="flex items-center gap-md">
                    <img src="${otherUser?.avatar || 'https://i.pravatar.cc/150'}" alt="${otherUserName}" class="avatar">
                    <div>
                        <p class="font-semibold">${otherUserName}</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400">${otherUser?.location || ''}</p>
                    </div>
                    <a href="profile.html?id=${otherUserId}" class="btn btn-outline btn-sm ml-auto">View Profile</a>
                </div>
            `;

            // Display messages
            displayMessages();

            // Show input
            document.getElementById('messageInputContainer').classList.remove('hidden');

            // Update conversations list
            displayConversations();
        }

        function displayMessages() {
            const container = document.getElementById('messagesList');
            container.innerHTML = '';

                if (!activeConversation || activeConversation.messages.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400">No messages yet. Start the conversation!</p>';
                return;
            }

            activeConversation.messages.forEach(msg => {
                const isSent = msg.senderId === currentUser.id;
                const messageEl = document.createElement('div');
                messageEl.className = `message ${isSent ? 'sent' : 'received'}`;
                messageEl.innerHTML = `
                    <p>${escapeHTML(msg.text)}</p>
                    <p class="text-xs mt-xs opacity-75">${new Date(msg.timestamp).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}</p>
                `;
                container.appendChild(messageEl);
            });

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        document.getElementById('messageForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const input = document.getElementById('messageInput');
            const text = input.value.trim();

            if (!text || !activeConversation) return;

            const newMessage = {
                id: activeConversation.messages.length + 1,
                senderId: currentUser.id,
                text: text,
                timestamp: new Date().toISOString()
            };

            activeConversation.messages.push(newMessage);
            activeConversation.lastMessage = text;
            activeConversation.lastMessageDate = newMessage.timestamp;

            input.value = '';
            displayMessages();
            displayConversations();
        });

        // Initial load
        displayConversations();
        if (activeConversation) {
            openConversation(activeConversation);
        }
    </script>
</body>

</html>